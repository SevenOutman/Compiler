function extend(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function $defined(e){return void 0!==e}function FileManager(){function e(e,t,n){var i=this;i.isNew=ko.observable($defined(n)?n:!0),i.name=ko.observable($defined(e)?e.replace(/(\.toy)$/,""):"untitled"),i.content=ko.observable(t||""),i.fileName=ko.computed(function(){return i.isNew()?i.name():i.name()+".toy"}),i.serialize=function(){return JSON.stringify({name:i.name(),content:i.content()})}}var t=this;t.files=ko.observableArray([]);var n=[];t.newFile=function(){var t=new e;return n.push(t),t},t.findFile=function(e){for(var n=0,i=t.files(),r=i.length;r>n;n++)if(i[n].fileName()==e)return i[n]},t.saveFile=function(e){e.isNew()&&(t.files.push(n.pop()),e.isNew(!1)),Storage.setItem(e.fileName(),e.serialize())},t.load=function(){for(var n=JSON.parse(Storage.getItem("stored-files")||"[]"),i=0,r=n.length;r>i;i++){var o=Storage.getItem(n[i]);if(o){var a=JSON.parse(o);t.files.push(new e(a.name,a.content,!1))}}},t.save=function(){for(var e=[],n=0,i=t.files(),r=i.length;r>n;n++)t.saveFile(i[n]),e[e.length]=i[n].fileName();Storage.setItem("stored-files",JSON.stringify(e))},t.load()}function EditorViewModel(e){function t(e){var t=this;t.file=e,t.isActive=ko.observable(!1),t.cachedContent=ko.observable(t.file.content()),t.unsaved=ko.computed(function(){return t.cachedContent()!=t.file.content()}),t.cursorPosition=ko.observable({line:0,ch:0}),t.history={done:[],undone:[]}}function n(e,t){var n=this;n.isOpen=ko.observable(!1);var i=null;n.name=ko.observable(""),n.rename=function(e){i=e,n.name(i.name()),n.isOpen(!0),$("#filename").select()},n.reset=function(){i=null,n.name("")},n.cancel=function(){n.isOpen(!1),n.reset()},n.confirm=function(){var r=n.name();if(e.findFile(r+".toy")&&!confirm("File '"+r+".toy' already exists. Want to overwrite?"))return $("#filename").select(),!1;i.name(n.name()),e.saveFile(i);var o=t.activeTab();o&&i==o.file&&(o.cachedContent(t.getEditorContent()),o.file.content(o.cachedContent()),e.saveFile(o.file)),n.isOpen(!1),n.reset()}}var i=this;i.renameDialog=new n(e,i),i.cm=CodeMirror.fromTextArea(document.getElementById("editor"),{lineNumbers:!0,mode:"toy",indentUnit:4,theme:"monokai-so",autoCloseBrackets:!0,matchBrackets:!0,styleActiveLine:!0,showCursorWhenSelecting:!0,scrollbarStyle:"overlay",selectionPointer:!0,styleSelectedText:!0}),i.cm.on("change",function(e,t){var n=i.activeTab();n&&n.cachedContent(i.getEditorContent())}),i.cm.on("cursorActivity",function(e){var t=i.activeTab();t&&t.cursorPosition(e.doc.getCursor())}),i.getEditorContent=function(){return i.cm.getValue()},i.setEditorContent=function(e){return i.cm.setValue(e)},i.tabs=ko.observableArray([]),i.activeTab=ko.observable(),i.setActive=function(e){var t=i.activeTab();t!=e&&(t&&(t.cursorPosition(i.cm.doc.getCursor()),t.history=i.cm.doc.getHistory(),t.cachedContent(i.getEditorContent()),t.isActive(!1)),i.activeTab(e),e&&(e.isActive(!0),i.setEditorContent(e.cachedContent()),i.cm.doc.setHistory(e.history),i.cm.doc.setCursor(e.cursorPosition()),i.cm.focus()))},i.unsaved=ko.computed(function(){var e=i.activeTab();return e&&e.unsaved()}),i.saveActiveTab=function(){var t=i.activeTab();(t.unsaved()||t.file.isNew())&&(t.file.isNew()?i.renameDialog.rename(t.file):(t.cachedContent(i.getEditorContent()),t.file.content(t.cachedContent()),e.saveFile(t.file)))},CodeMirror.commands.save=function(){i.saveActiveTab()},i.openNewFile=function(){i.openFile(e.newFile())},i.openFile=function(e){for(var n=0,r=i.tabs(),o=r.length;o>n;n++){var a=r[n];if(a.file==e)return void i.setActive(a)}var a=new t(e);i.tabs.push(a),i.setActive(a)},i.closeTab=function(e){i.tabs.remove(e),i.activeTab()==e&&i.setActive(i.tabs().rear())},i.cursorPosText=ko.computed(function(){var e=i.activeTab();if(e){var t=e.cursorPosition();return t.line+1+":"+(t.ch+1)}return""}),i.load=function(){var t=JSON.parse(Storage.getItem("opened-files")||"[]"),n=Storage.getItem("last-editing");t.push(n);for(var r=0,o=t.length;o>r;r++){var a=t[r],s=e.findFile(a);s&&i.openFile(s)}},i.save=function(){for(var e=[],t=0,n=i.tabs(),r=n.length;r>t;t++){var o=n[t];e[e.length]=o.file.fileName(),o.isActive()&&Storage.setItem("last-editing",o.file.fileName())}Storage.setItem("opened-files",JSON.stringify(e))},i.load()}function WorkspaceViewModel(e,t){function n(e){var t=this;t.file=e,t.attrId=ko.computed(function(){return"toy-"+t.file.name()}),t.isActive=ko.observable(!1)}var i=this;i.rows=ko.computed(function(){return $.map(e.files(),function(e){return new n(e)})});var r=null;i.setActive=function(e){r&&r.isActive(!1),(r=e).isActive(!0)},i.openFileInEditor=function(e){t.openFile(e.file)},i.importFile=function(){var t=new FileReader,n=null;t.onload=function(){null!==n&&(n.content(this.result),e.files.push(n),i.openFileInEditor(n),n=null)};var r=$(document.createElement("input")).attr({type:"file"});r.on("change",function(){var e=$(this)[0].files[0];n=new ToyFile(e.name.replace(/(\.\w+)?$/,".toy")),n.isNew(!1),t.readAsText(e)}),r.trigger("click")}}function Openable(){var e=this;e.isOpen=ko.observable(!1),e.open=function(){e.isOpen(!0)},e.close=function(){e.isOpen(!1)}}function ConsoleViewModel(){function e(e,t){return e+t.replace(/\s*\n/g,"\n  ")+"\n"}function t(e,t){return e.split("\n").slice(-t).join("\n")}var n=this;n.cm=CodeMirror.fromTextArea(document.getElementById("console"),{theme:"monokai-so",mode:"console",readOnly:"nocursor",scrollbarStyle:"overlay",viewportMargin:1/0}),n.scollToEnd=function(){n.cm.scrollIntoView(n.cm.doc.lastLine(),1)},n.cm.on("change",function(e){e.scrollIntoView(e.doc.lastLine(),1)}),n.log=function(i){n.cm?n.cm.setValue(t(n.cm.getValue()+e(": ",i),1e3)):window.console.log(i)},n.error=function(i){i&&(n.cm?(i instanceof Object&&(i=i.toString()),n.cm.setValue(t(n.cm.getValue()+e("- ",i),1e3))):window.console.log(i))},n.success=function(i){i&&(n.cm?n.cm.setValue(t(n.cm.getValue()+e("+ ",i),1e3)):window.console.log(i))},n.warn=function(i){i&&(n.cm?n.cm.setValue(t(n.cm.getValue()+e("@ ",i),1e3)):window.console.log(i))},n.popup=function(){$("#box-opener-console").trigger("click")}}function MainViewModel(){var e=this,t=e.fileManager=new FileManager,n=e.editor=new EditorViewModel(t);e.workspace=new WorkspaceViewModel(t,n),e.console=new ConsoleViewModel,e.aboutCard=new Openable}function ToyFile(e,t,n){this.isNewFile=void 0!==n?n:!0,this.name=void 0!==e?e.replace(/(\.toy)$/,""):"untitled",this.content=t||"",this.tree=null,this.assembly=null}function SemanticAnalyzer(){function e(e,t,n,i){var r=null===t?"":t,o=null===n?"":n,a=null===i?"":i;return"    "+e+" "+r+", "+o+", "+a}function t(u){var d,f,p,m=i.rear();switch(i.push(u),u["abstract"]){case"program":t(u.subNodes[0]);break;case"compoundstmt":t(u.subNodes[1]);break;case"stmts":t(u.subNodes[0]),u.subNodes[1]&&t(u.subNodes[1]);break;case"stmt":t(u.subNodes[0]);break;case"decl":u.value=t(u.subNodes[0]).value,t(u.subNodes[1]);break;case"type":u.value=u.subNodes[0]["abstract"];break;case"list":u.value=m.value,t(u.subNodes[0]),t(u.subNodes[1]);break;case"ID":var h=n.get(u.name);switch(void 0===h.occurance?h.occurance=0:h.occurance++,m["abstract"]){case"list":u.type=m.value,h.type&&o.push(new SemanticError("Duplicated declaration of '"+h.name+"'",h.positions[h.occurance])),h.type=u.type;break;default:h.type||0!==h.occurance||o.push(new SemanticError("Undeclared identifier '"+h.name+"'",h.positions[h.occurance]))}break;case"list1":u.value=m.value,u.subNodes[1]&&t(u.subNodes[1]);break;case"assgstmt":u.value=t(u.subNodes[2]).value;var g=t(u.subNodes[0]).name;r[r.length]=e("mov",g,null,u.value);break;case"arithexpr":if(d=t(u.subNodes[0]),f=t(u.subNodes[1]),f.type)switch(f.type){case"+":u.value=c(a++),r[r.length]=e("add",u.value,d.value,f.value);break;case"-":u.value=c(a++),r[r.length]=e("sub",u.value,d.value,f.value)}else u.value=d.value;break;case"multexpr":if(d=t(u.subNodes[0]),f=t(u.subNodes[1]),f.type)switch(f.type){case"*":u.value=c(a++),r[r.length]=e("mul",u.value,d.value,f.value);break;case"/":u.value=c(a++),0===f.value?(o.push(new SemanticError("Cannot be divided by 0")),r[r.length]=e("*div",u.value,d.value,f.value)):r[r.length]=e("div",u.value,d.value,f.value)}else u.value=d.value;break;case"arithexprprime":if(u.subNodes[2])if(u.type=u.subNodes[0]["abstract"],d=t(u.subNodes[1]),f=t(u.subNodes[2]),f.type)switch(f.type){case"+":u.value=c(a++),r[r.length]=e("add",u.value,d.value,f.value);break;case"-":u.value=c(a++),r[r.length]=e("sub",u.value,d.value,f.value)}else u.value=d.value;break;case"simpleexpr":if(u.subNodes[1])u.value=t(u.subNodes[1]).value;else{var v=t(u.subNodes[0]);switch(v["abstract"]){case"ID":u.value=v.name;break;case"NUM":u.value=v.value}}break;case"multexprprime":if(u.subNodes[2])if(u.type=u.subNodes[0]["abstract"],d=t(u.subNodes[1]),f=t(u.subNodes[2]),f.type)switch(f.type){case"*":u.value=c(a++),r[r.length]=e("mult",u.value,d.value,f.value);break;case"/":u.value=c(a++),0===f.value?(o.push(new SemanticError("Cannot be divided by 0")),r[r.length]=e("*div",u.value,d.value,f.value)):r[r.length]=e("div",u.value,d.value,f.value)}else u.value=d.value;break;case"whilestmt":var b=u.subNodes[2],w=u.subNodes[4];r[r.length]=l(s++),t(b),t(w),r[r.length]=e("jmp",null,null,"f"+(s-1));break;case"boolexpr":u.value="t"+a++,p=u.subNodes[1];var x=u.subNodes[0],$=u.subNodes[2];switch(d=t(x),f=t($),t(p).value){case"<":r[r.length]=e("lt",u.value,d.value,f.value);break;case">":r[r.length]=e("gt",u.value,d.value,f.value);break;case"<=":r[r.length]=e("le",u.value,d.value,f.value);break;case">=":r[r.length]=e("ge",u.value,d.value,f.value);break;case"==":r[r.length]=e("eq",u.value,d.value,f.value)}r[r.length]=e("jmpf",u.value,null,"f"+s);break;case"boolop":u.value=u.subNodes[0]["abstract"];break;case"ifstmt":p=u.subNodes[2];var y=u.subNodes[5],N=u.subNodes[7];r[r.length]=l(s++),t(p),t(y),r[r.length]=e("jmp",null,null,"f"+(s+1)),r[r.length]=l(s++),t(N)}return i.pop(),u}var n,i,r,o,a=0,s=0,l=function(e){return"f"+e},c=function(e){return"t"+e},u=function(){n=null,i=[],o=[],r=[],a=0,s=0},d=function(e,i){u(),n=i,n.get=function(e){for(var t=0;t<n.length;t++)if(n[t].name==e)return n[t]},t(e),s>0&&(r[r.length]=l(s)),P("symboltablechanged",n)};return{eat:d,getErrorMsg:function(){return o.join("\n")},getAssembly:function(){return r.join("\n")}}}function SemanticError(e,t){this.msg=e,this.position=t}var Benchmark=function(e){var t={},n=function(n){t[n]=e.performance?e.performance.now():(new Date).getTime()},i=function(n){var i=e.performance?e.performance.now():(new Date).getTime();return i-t[n]},r=function(e,t,r){n("test");for(var a=0;t>a;a++)e.apply(r||this,Array.prototype.slice.call(arguments,3));var s=i("test");return o("test"),s},o=function(e){delete t[e]};return{mark:n,measure:i,test:r,clear:o}}(window);const Invalid=void 0;Array.prototype.has=function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return!0;return!1},Array.prototype.rear=function(){return this[this.length-1]},Array.prototype.front=function(){return this[0]},Array.prototype.remove=function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return this.splice(t,1)},String.prototype.repeat||(String.prototype.repeat=function(e){"use strict";var t="",n=this;if(1>e)return t;for(;e>1;)1&e&&(t+=n),e>>=1,n+=n;return t+n}),Math.mid=function(e,t,n){if(3!=arguments.length)throw new Error("Math.mid requires exactly 3 arguments.");return[e,t,n].sort(function(e,t){return e-t})[1]};var _randomString=function(e){if(e>5)return _randomString(e-5)+_randomString(5);for(var t,n,i="",r=Math.pow(64,e),o=Math.floor(Math.random()*r),a=51/63;i.length<e;)t=o%64,n=Math.floor(t*a),o=(o-t)/64,i+=String.fromCharCode(65+(n>25?n+6:n));return i};!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";e.defineMode("toy",function(e,t){function n(e,t){var n=e.next();return a.test(n)?(e.eatWhile(/^[*+\-<>!=\/]/),/^\/\//.test(e.current())?(e.skipToEnd(),"comment"):"operator"):/\d/.test(n)?(e.match(/^[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?/),"number"):r.test(n)?(e.eatWhile(r),o.test(e.current())?"keyword":"variable"):null}var i=e.indentUnit,r=t.wordCharacters||/[\w$\xa1-\uffff]/,o=/\b(int|real|if|else|then|while)\b/,a=/^(\+|\-|\*|\/|>=?|<=?|==?)$/;return{startState:function(){return{indentStack:[]}},token:function(e,t){if(e.eatSpace())return null;var i=n(e,t),r=e.current();return["{","then","else"].has(r)?("{"==r&&"{"!=t.indentStack.rear()&&t.indentStack.pop(),t.indentStack.push(r)):"}"===r?"{"==t.indentStack.rear()&&t.indentStack.pop():";"===r&&["else","then"].has(t.indentStack.rear())&&t.indentStack.pop(),i},indent:function(e,t){var n=t&&t.charAt(0);return"}"==n&&"{"==e.indentStack.rear()&&e.indentStack.pop(),e.indentStack.length*i},electricInput:/^\s*(?:\{|})$/}})}),function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";e.defineMode("console",function(e,t){var n={"+":"positive","-":"negative",":":"comment","@":"def"};return{startState:function(){return{ctx:n[":"]}},token:function(e,t){var i=e.string.search(/[\t ]+?$/);if(!e.sol()||0===i)return e.skipToEnd(),t.ctx;var r=n[e.peek()]||e.skipToEnd();-1===i?e.skipToEnd():e.pos=i;var o=t.ctx=r||t.ctx;return o}}})}),function(e){var t={},n=function(e,n){if(e&&t[e])for(var i=0;i<t[e].length;i++)setTimeout(function(e,t){return function(){e.apply(t,n)}}(t[e][i],this),0)},i=function(e,n){"function"==typeof n&&(t[e]||(t[e]=[]),t[e].push(n))};e.P=function(e){return n(e,Array.prototype.slice.call(arguments,1)),{p:P}},e.S=function(e,t){return i(e,t),{s:S}}}(window);var Storage=function(){var e="test",t=window.localStorage;try{return t.setItem(e,"1"),t.removeItem(e),t}catch(n){return t=function(){var e={};return{setItem:function(t,n){return e[t]=String(n),e[t]},getItem:function(t){return e.hasOwnProperty(t)?this._data[t]:void 0},removeItem:function(t){return delete e[t]},clear:function(){return e={}}}}()}}(),Cache={};ToyFile.prototype.extension=".toy",ToyFile.prototype.fileName=function(){return this.isNewFile?this.name:this.name+this.extension},ToyFile.prototype.serialize=function(){return JSON.stringify({name:this.name,content:this.content})};var View=function(){function e(e,t){return e+t.replace(/\s*\n/g,"\n  ")+"\n"}function t(e,t){return e.split("\n").slice(-t).join("\n")}var n={};n.cm=CodeMirror.fromTextArea(document.getElementById("editor"),{lineNumbers:!0,mode:"toy",indentUnit:4,theme:"monokai-so",autoCloseBrackets:!0,matchBrackets:!0,styleActiveLine:!0,showCursorWhenSelecting:!0,scrollbarStyle:"overlay",selectionPointer:!0,styleSelectedText:!0}),n.cm.on("change",function(e,t){var i=n.currentSession();return null===i?void document.getElementById("btn-save").classList.remove("unsaved"):(i.saved&&(i.saved=!1),void(document.getElementById("btn-save").classList.hasOwnProperty("unsaved")||document.getElementById("btn-save").classList.add("unsaved")))}),n.cm.on("cursorActivity",function(e){var t=e.doc.getCursor();$("#current-line").text(t.line+1),$("#current-ch").text(t.ch+1)}),n.getContent=function(){return n.cm.getValue()},n.setContent=function(e){return n.cm.setValue(e)},n.openedSessions=[],n.openedSessions.find=function(e){for(var t=0;t<this.length;t++)if(this[t].id===e)return this[t];return null}.bind(n.openedSessions),n.openedSessions.findFile=function(e){for(var t=0;t<this.length;t++)if(this[t].file.fileName()===e)return this[t];return null}.bind(n.openedSessions),n.currentSession=function(){var e=null;return function(t){if(t&&t!==e){null!==e&&(e.content=n.getContent(),e.history=n.cm.doc.getHistory(),e.cursorPosition=n.cm.doc.getCursor()),e=t,n.setContent(e.content),n.cm.doc.setHistory(e.history),n.cm.doc.setCursor(e.cursorPosition);var i="session-"+e.id,r=$("#"+i);if(r.length<1){var o=$("<a></a>").text(t.file.fileName()),a=$("<span></span>").addClass("tab-dismiss").html("&times;");r=$("<div></div>").attr("id",i).addClass("tab-cell"),a.on("click",function(e){return function(){return View.editor.closeSession(e),!1}}(t)),r.on("click",function(e){return function(){n.bringSessionToFront(e)}}(t)),$(".tab-group").append(r.append(o.append(a)))}r.hasClass("active")||(r.siblings(".active").removeClass("active"),r.addClass("active"))}else null===t&&(e=null,n.setContent(""),$(".editor-placeholder").show(),$("#cursor-position").hide());return e}}(),n.bringSessionToFront=function(e){var t=e.saved;n.currentSession(e),n.cm.focus(),t&&View.editor.save(!0)},n.closeSession=function(e){n.openedSessions.remove(e);var t="session-"+e.id,i=$("#"+t);if(i.remove(),n.currentSession()==e){var r=n.openedSessions.front();void 0===r?n.currentSession(null):n.bringSessionToFront(r)}},n.openFile=function(e){return},n.newFile=function(){n.openFile(new ToyFile)},n.save=function(e){var t=n.currentSession();if(t){if(!e&&t.file.isNewFile)return void n.dialogRenameFile(t.file);(e||!t.saved)&&(t.file.content=t.content=n.getContent(),Storage.setItem(t.file.fileName(),t.file.serialize()),e||r.log("Saved to '"+t.file.fileName()+"'"),t.saved=!0,document.getElementById("btn-save").classList.remove("unsaved"))}},n.needSave=function(){return n.currentSession()?!n.currentSession().saved:!1};var i=null;n.dialogRenameFile=function(e){i=e,null!==i&&($("#filename").val(e.name),$("#dialog-mask").show(),$("#filename").select())},n.confirmRename=function(){if(null!==i){var e=$("#filename").val();if(null!==Cache.files.find(e+".toy")&&!confirm("File '"+e+".toy' already exists. Want to overwrite?"))return $("#filename").select(),!1;$("#dialog-mask").hide(),$("#filename").val("");var t="toy-"+i.name;if(i.name=e,i.isNewFile){if(i.isNewFile=!1,n.save(),Cache.files.push(i),t="toy-"+e,$("#"+t).length<1){var r=$("<li></li>").attr("id",t).text(i.fileName()),o=$("<span></span>").addClass("glyphicon glyphicon-file");r.on("click",function(){var e=$(this);e.hasClass("active")||(e.siblings(".active").removeClass("active"),e.addClass("active"))}).on("contextmenu",function(){$(this).trigger("click")}).on("dblclick",function(e){return function(){View.editor.openFile(e)}}(i)),$("#file-list").append(r.prepend(o))}}else{var r=$("#"+t),o=$("<span></span>").addClass("glyphicon glyphicon-file");r.attr("id","toy-"+e).text(i.fileName()).prepend(o)}var a=n.openedSessions.findFile(i.fileName());if(a){var s=n.cm.doc.getCursor();n.closeSession(a),n.openFile(i),n.cm.doc.setCursor(s)}i=null}};var r={};r.cm=CodeMirror.fromTextArea(document.getElementById("console"),{theme:"monokai-so",mode:"console",readOnly:"nocursor",scrollbarStyle:"overlay",viewportMargin:1/0}),r.scollToEnd=function(){r.cm.scrollIntoView(r.cm.doc.lastLine(),1)},r.cm.on("change",function(e){e.scrollIntoView(e.doc.lastLine(),1)}),r.log=function(n){r.cm?r.cm.setValue(t(r.cm.getValue()+e(": ",n),1e3)):window.console.log(n)},r.error=function(n){n&&(r.cm?(n instanceof Object&&(n=n.toString()),r.cm.setValue(t(r.cm.getValue()+e("- ",n),1e3))):window.console.log(n))},r.success=function(n){n&&(r.cm?r.cm.setValue(t(r.cm.getValue()+e("+ ",n),1e3)):window.console.log(n))},r.warn=function(n){n&&(r.cm?r.cm.setValue(t(r.cm.getValue()+e("@ ",n),1e3)):window.console.log(n))},r.popup=function(){$("#box-opener-console").trigger("click")};var o={};o.compiling=null,o.compilie=function(e){o.compiling=e,o.enterCompileMode()},o.enterCompileMode=function(){if(null!==o.compiling){$("body").addClass("compiling"),$("#compiling-filename").text(o.compiling.fileName()),$("#editing-btn-group").hide(),$("#compiling-btn-group").show(),$(".tab-bar-cover").show(),$(".tree-box").removeClass("assembly"),s.cm.setValue(""),$("#box-opener-tree").trigger("click"),$("#box-opener-structure").trigger("click");var e=$(".bottom-box");e.hasClass("hidden")&&e.removeClass("hidden"),e.css("height","30%"),$(".upper-box").css("height","70%"),a.clear().setOptions({width:$(".tree-box .box-body").width(),height:$(".tree-box .box-body").height()}),a.setSource([["0","program",1,"","1","0"]]),a.render(),$(".tree-box .placeholder").hide(),$(".left-box .box-caret").trigger("click"),n.cm.setOption("readOnly","nocursor"),r.cm.setValue("")}},o.exitCompileMode=function(){$("body").removeClass("compiling"),$("#compiling-btn-group").hide(),$("#editing-btn-group").show(),$(".tab-bar-cover").hide(),$("#box-opener-workspace").trigger("click"),$(".right-box .box-caret").trigger("click"),$(".tree-box .box-caret").trigger("click"),$(".bottom-box").hasClass("hidden")||($(".bottom-box").css("height","30%"),$(".upper-box").css("height","70%")),n.cm.setOption("readOnly",!1),o.compiling=null,$("#compiling-filename").text("")};var a=new Tree("tree-pane",{radius:10});a.clear=function(){return a.canvas.clear(),a},S("treeboxresized",function(){a.render({width:$(".tree-box .box-body").width(),height:$(".tree-box .box-body").height()})});var s={};return s.cm=CodeMirror.fromTextArea(document.getElementById("assembly"),{theme:"monokai-so",mode:"console",readOnly:"nocursor",scrollbarStyle:"overlay",viewportMargin:1/0}),{assembly:s,editor:n,console:r,control:o,treePen:a}}(),SymbolTable={"new":function(){var e,t,n={},i=0;return n.handle=function(n){function r(n){var r={name:n.lexeme,type:void 0,value:void 0,positions:[n.position]};e.push(r),t[n.lexeme]=i,i+=1}function o(n){e[t[n.lexeme]].positions.push(n.position)}e.hasOwnProperty(t[n.lexeme])?o(n):r(n)},n.reset=function(){e=[],t={},i=0},n.get=function(){return e.slice()},n.getD=function(){},n.getLength=function(){return i},n}},Lexer={"new":function(){var e,t,n,i,r,o,a,s,l=[{regExp:/^int$/,"abstract":"int",containValue:"false"},{regExp:/^real$/,"abstract":"real",containValue:"false"},{regExp:/^if$/,"abstract":"if",containValue:"false"},{regExp:/^then$/,"abstract":"then",containValue:"false"},{regExp:/^else$/,"abstract":"else",containValue:"false"},{regExp:/^while$/,"abstract":"while",containValue:"false"},{regExp:/^\($/,"abstract":"(",containValue:"true"},{regExp:/^\)$/,"abstract":")",containValue:"true"},{regExp:/^\{$/,"abstract":"{",containValue:"true"},{regExp:/^\}$/,"abstract":"}",containValue:"true"},{regExp:/^,$/,"abstract":",",containValue:"true"},{regExp:/^;$/,"abstract":";",containValue:"true"},{regExp:/^\+$/,"abstract":"+",containValue:"true"},{regExp:/^-$/,"abstract":"-",containValue:"true"},{regExp:/^\*$/,"abstract":"*",containValue:"true"},{regExp:/^\/$/,"abstract":"/",containValue:"true"},{regExp:/^[a-zA-Z][a-zA-Z0-9]*$/,"abstract":"ID",containValue:"true"},{regExp:/^<=$/,"abstract":"<=",containValue:"true"},{regExp:/^<$/,"abstract":"<",containValue:"true"},{regExp:/^\=\=$/,"abstract":"==",containValue:"true"},{regExp:/^>=$/,"abstract":">=",containValue:"true"},{regExp:/^>$/,"abstract":">",containValue:"true"},{regExp:/^!=$/,"abstract":"!=",containValue:"true"},{regExp:/^\=$/,"abstract":"=",containValue:"true"},{regExp:/^[0-9]*\.[0-9]+$/,"abstract":"NUM",containValue:"true"},{regExp:/^[0-9]+\.?$/,"abstract":"NUM",containValue:"true"}],c={"new":function(){var e,t,n,i,r={};return r.reset=function(){e=1,n=1,t=1,i=1},r.shift=function(e){i+=e},r.newLine=function(){i=1,n++},r.reduce=function(){e=n,t=i},r.get=function(){return{first_row:e,last_row:n,first_col:t,last_col:i}},r}},u=c["new"](),d=SymbolTable["new"](),f={},p=["NORMAL","ERROR","DONE"],m=!1,h=0;return f.getErrMsg=function(){return n},f.getStatus=function(){return e},f.getSymbolTable=function(){return d.get()},f.setInput=function(t){f.reset(),i=t,e=p[0]},f.reset=function(){d.reset(),u.reset(),n="",t=[],r="",h=0,e=p[2],m=!1},f.lexDone=function(){return e==p[2]},f.lex=function(c){function f(e){var t;for(t=0;t<l.length;t+=1)if(l.hasOwnProperty(t)&&e.match(l[t].regExp))return{lexeme:e,"abstract":l[t]["abstract"],position:u.get(),containValue:l[t].containValue};return!1}if(e!=p[0])return!1;for(r="";h<i.length;){if(a=i[h],o=f(r+a))r+=a,u.shift(1);else{if("NUM"==f(r)["abstract"]&&"ID"==f(a)["abstract"])return n="UNDEFINED SYMBOL '"+r+a+"' AT ROW "+u.get().first_row+", COL "+u.get().first_col,e=p[1],!1;if(""==r)if(null!=a.match(/\ /))u.shift(1);else if(null!=a.match(/\t/))u.shift(4);else{if(null==a.match(/\n/))return n="UNDEFINED SYMBOL '"+a+"' AT ROW "+u.get().first_row+", COL "+u.get().first_col,e=p[1],!1;u.newLine()}else if(h-=1,s=f(r),t.push(s),"ID"==s["abstract"]&&d.handle(s),c)return u.reduce(),r="",h+=1,!0;u.reduce(),r=""}h+=1}return(s=f(r))?(t.push(s),!0):(u.reduce(),s={lexeme:"$","abstract":"$",position:u.get()},t.push(s),e=p[2],!0)},f.getToken=function(){return s},f.getSequence=function(){return t},f.getSequenceByAbstract=function(){var e,n="";for(e=0;e<t.length;e+=1)n+=t[e]["abstract"]+" ";return n},f.getSequenceByLexeme=function(){var e,n="";for(e=0;e<t.length;e+=1)n+=t[e].lexeme+" ";return n},f}},Parser={"new":function(){var e,t,n,i,r,o,a,s,l,c,u,d,f,p,m,h,g=[{},{interminal:"program",product:["compoundstmt"]},{interminal:"stmt",product:["decl"]},{interminal:"stmt",product:["ifstmt"]},{interminal:"stmt",product:["whilestmt"]},{interminal:"stmt",product:["assgstmt"]},{interminal:"stmt",product:["compoundstmt"]},{interminal:"compoundstmt",product:["{","stmts","}"]},{interminal:"stmts",product:["stmt","stmts"]},{interminal:"stmts",product:[]},{interminal:"ifstmt",product:["if","(","boolexpr",")","then","stmt","else","stmt"]},{interminal:"whilestmt",product:["while","(","boolexpr",")","stmt"]},{interminal:"assgstmt",product:["ID","=","arithexpr",";"]},{interminal:"decl",product:["type","list",";"]},{interminal:"type",product:["int"]},{interminal:"type",product:["real"]},{interminal:"list",product:["ID","list1"]},{interminal:"list1",product:[",","list"]},{interminal:"list1",product:[]},{interminal:"boolexpr",product:["arithexpr","boolop","arithexpr"]},{interminal:"boolop",product:["<"]},{interminal:"boolop",product:[">"]},{interminal:"boolop",product:["<="]},{interminal:"boolop",product:[">="]},{interminal:"boolop",product:["=="]},{interminal:"arithexpr",product:["multexpr","arithexprprime"]},{interminal:"arithexprprime",product:["+","multexpr","arithexprprime"]},{interminal:"arithexprprime",product:["-","multexpr","arithexprprime"]},{interminal:"arithexprprime",product:[]},{interminal:"multexpr",product:["simpleexpr","multexprprime"]},{interminal:"multexprprime",product:["*","simpleexpr","multexprprime"]},{interminal:"multexprprime",product:["/","simpleexpr","multexprprime"]},{interminal:"multexprprime",product:[]},{interminal:"simpleexpr",product:["ID"]},{interminal:"simpleexpr",product:["NUM"]},{interminal:"simpleexpr",product:["(","arithexpr",")"]}],v={program:{"{":1,"}":0,"if":0,"(":0,")":0,then:0,"else":0,"while":0,"int":0,real:0,ID:0,NUM:0,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},stmt:{"{":6,"}":0,"if":3,"(":0,")":0,then:0,"else":0,"while":4,"int":2,real:2,ID:5,NUM:0,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},compoundstmt:{"{":7,"}":0,"if":0,"(":0,")":0,then:0,"else":0,"while":0,"int":0,real:0,ID:0,NUM:0,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},stmts:{"{":8,"}":9,"if":8,"(":0,")":0,then:0,"else":0,"while":8,"int":8,real:8,ID:8,NUM:0,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},ifstmt:{"{":0,"}":0,"if":10,"(":0,")":0,then:0,"else":0,"while":0,"int":0,real:0,ID:0,NUM:0,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},whilestmt:{"{":0,"}":0,"if":0,"(":0,")":0,then:0,"else":0,"while":11,"int":0,real:0,ID:0,NUM:0,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},assgstmt:{"{":0,"}":0,"if":0,"(":0,")":0,then:0,"else":0,"while":0,"int":0,real:0,ID:12,NUM:0,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},decl:{"{":0,"}":0,"if":0,"(":0,")":0,then:0,"else":0,"while":0,"int":13,real:13,ID:0,NUM:0,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},type:{"{":0,"}":0,"if":0,"(":0,")":0,then:0,"else":0,"while":0,"int":14,real:15,ID:0,NUM:0,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},list:{"{":0,"}":0,"if":0,"(":0,")":0,then:0,"else":0,"while":0,"int":0,real:0,ID:16,NUM:0,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},list1:{"{":0,"}":0,"if":0,"(":0,")":0,then:0,"else":0,"while":0,"int":0,real:0,ID:0,NUM:0,",":17,";":18,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},boolexpr:{"{":0,"}":0,"if":0,"(":19,")":0,then:0,"else":0,"while":0,"int":0,real:0,ID:19,NUM:19,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},boolop:{"{":0,"}":0,"if":0,"(":0,")":0,then:0,"else":0,"while":0,"int":0,real:0,ID:0,NUM:0,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":20,">":21,"<=":22,">=":23,"==":24,$:0},arithexpr:{"{":0,"}":0,"if":0,"(":25,")":0,then:0,"else":0,"while":0,"int":0,real:0,ID:25,NUM:25,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},arithexprprime:{"{":0,"}":0,"if":0,"(":0,")":28,then:0,"else":0,"while":0,"int":0,real:0,ID:0,NUM:0,",":0,";":28,"+":26,"-":27,"*":0,"/":0,"=":0,"<":28,">":28,"<=":28,">=":28,"==":28,$:0},multexpr:{"{":0,"}":0,"if":0,"(":29,")":0,then:0,"else":0,"while":0,"int":0,real:0,ID:29,NUM:29,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0},multexprprime:{"{":0,"}":0,"if":0,"(":0,")":32,then:0,"else":0,"while":0,"int":0,real:0,ID:0,NUM:0,",":0,";":32,"+":32,"-":32,"*":30,"/":31,"=":0,"<":32,">":32,"<=":32,">=":32,"==":32,$:0},simpleexpr:{"{":0,"}":0,"if":0,"(":35,")":0,then:0,"else":0,"while":0,"int":0,real:0,ID:33,NUM:34,",":0,";":0,"+":0,"-":0,"*":0,"/":0,"=":0,"<":0,">":0,"<=":0,">=":0,"==":0,$:0}},b={"new":function(e,t){var n={},i=[];return n.fatherNode=t,n["abstract"]=e,n.name=Invalid,n.value=Invalid,n.type=Invalid,n.formula=Invalid,n["new"]=!0,n.parsed=!1,n.addSubNode=function(e){i.unshift(e)},n.getSubNodes=function(){return i.slice()},n.setPosition=function(e){n.position=e},n.assign=function(e,t){if(e.containValue)switch(e["abstract"]){case"ID":n.name=e.lexeme,n.type=void 0,n.value=void 0;break;case"NUM":n.type=void 0,n.value=Number(e.lexeme);break;case"type":n.value=e.lexeme.toLowerCase()}n.formula=t},n.shiftSubNode=function(){i.shift()},$.push(n),n},epsilon:function(){var e={},t=[];return e["abstract"]="ε",e.name=Invalid,e.value=Invalid,e.type=Invalid,e.parsed=!1,e.getSubNodes=function(){return t.slice()},e}},w={},x=["NORMAL","WARNING","ERROR","DONE"],$=[];return w.getStatus=function(){return e},w.reset=function(){parseErr=!1,a=["$","program"],s=[],t=[],i="",r=[],o="",$=[],n=b["new"]("program",b["new"]()),c=[n],f=0,e=x[3],l=[a.slice(),s.slice(),{}],h=!1},w.setInput=function(t){w.reset(),s=t,e=x[0]},w.pushToken=function(e){nextT=e,next=nextT["abstract"],s.push(e)},w.parse=function(n){function w(e){var t;for(t=0;t<g.length;t+=1)if(g[t].interminal==e)return!1;return!0}function y(){for(var e=0;e<$.length;e++)$[e]["new"]=!1;$=[]}if(e!=x[0]&&e!=x[1])return!1;l=[a.slice(),s.slice(),{}];var N=a.pop(),C=s[0],S=C["abstract"];for(u=c.pop();"$"!=N&&s.length>0;){if(y(),N!=S||h){if(h&&"stmts"!=N)e=x[1],o=["UNEXPECTED",C.lexeme,"AT","ROW",d.last_row+",","COL",d.last_col+".","POPPED","OUT","'"+N+"'"].join(" "),l[2]=o,r.push(o),u.parsed=!0;else if(h&&"stmts"==N){if(c.push(m),a.push("stmts"),u!=m)for(;m.getSubNodes().length>0;)m.shiftSubNode();v[N][S]>0?(h=!1,o="RECOVERY DONE",l[2]=o,r.push(o)):(s.shift(),e=x[1],o="SKIPPED '"+S+"' AT ROW "+C.position.first_row+", COL "+C.position.first_col,l[2]=o,r.push(o))}else if(w(N))h=!0,e=x[1],o=["UNEXPECTED",C.lexeme,"AT","ROW",d.last_row+",","COL",d.last_col+".","POPPED","OUT","'"+N+"'"].join(" "),l[2]=o,r.push(o),u.parsed=!0;else if(0==v[N][S])Number(C.position.first_row)>Number(d.last_row)?(e=x[1],o=["EXPECTED",";","AT","ROW",d.last_row+",","COL",d.last_col].join(" "),l[2]=o,r.push(o),s.unshift({lexeme:";","abstract":";",position:d,containValue:!0})):("stmts"!=N&&(h=!0),a.push(N),c.push(u),s.shift(),e=x[1],o="SKIPPED '"+S+"' AT ROW "+C.position.first_row+", COL "+C.position.first_col,l[2]=o,r.push(o));else if(v[N][S]>0){
p=v[N][S];var k,E,V=v[N][S],M=g[V].product.slice();for(0==M.length?(u.addSubNode(b.epsilon()),u.parsed=!0):"stmts"==g[V].interminal&&(m=u);M.length>0;)k=M.pop(),a.push(k),E=b["new"](k,u),u.addSubNode(E),c.push(E);l[2]=g[V]}}else d=C.position,u.setPosition(C.position),u.parsed=!0,u.assign(C,p),s.shift();if(e!=x[2]&&t.push(l),e==x[2]||n)return f+=1,e!=x[2];n||(l=[a.slice(),s.slice(),{}],N=a.pop(),C=s[0],S=C["abstract"])}return N==S&&s.shift(),0==s.length?(t.push(l),e=x[3],!0):(e=x[2],i="CAME UP WITH UNEXPECTED TERMINAL '"+C.lexeme+"' AT ROW "+C.position.first_row+", COL "+C.position.first_col,!1)},w.parseDone=function(){return e==x[3]},w.needPush=function(){return 0==s.length},w.getRootS=function(){function e(t,n){var i={},r=[],o=t.getSubNodes();i["abstract"]=t["abstract"],i.name=t.name,i.value=t.value,i.type=t.type,i.subNodes=r,i.fatherNode=n,void 0!=t.position&&(i.position=t.position);var a;for(a=0;a<o.length;a++)r.push(e(o[a],i));return i}return e(n,void 0)},w.getSequentialNodes=function(){function e(t){var n=t.getSubNodes();if(n.length>0){for(var i=!0,r=0;r<n.length;r++)n[r].parsed||(e(n[r]),n[r].parsed||(i=!1));t.parsed=i}}function t(){function e(n,i,r){var o=t.toString();if(t+=1,typeof i==typeof b["new"]()){var a,s,l,c=[],u=[o,i["abstract"],0,n,r?"1":"0",i["new"]?"1":"0"],d=i.getSubNodes(),f=0;for(s=0;s<d.length;s+=1)if(!d[s].parsed){for(f+=1,a=e(o,d[s],1==f&&r),l=0;l<a.length;l+=1)c.push(a[l]);a.length>0&&(u[2]+=a[0][2]+1)}return c.unshift(u),c}}var t=0;return e("",n,!0)}return e(n),t()},w.treeChanged=function(){return!0},w.getErrMsg=function(){return i},w.getWarningMsg=function(){return r.join("\n")},w.getMovementsF=function(){function e(e,t){for(;e.length<t;)e+=" ";return e}var n,i,r,o,a,s,l,c=[],u=0,d=0,f=0,p=22;for(s=0;s<t.length;s+=1){for(n=t[s],i=[],r=n[0].join(" "),u=Math.max(u,r.length),i.push(r),o="| ",l=0;l<n[1].length;l+=1)o+=n[1][l].lexeme+" ";o=o.indexOf(";")>-1?o.split(";")[0]+";":o.split(";")[0],o.length>p&&(o=o.substring(0,p)+" ..."),d=Math.max(d,o.length),i.push(o),a="| ",n[2].hasOwnProperty("interminal")?(a+=n[2].interminal+" -> ",a+=n[2].product.length>0?n[2].product.join(" "):"ε",f=Math.max(f,a.length)):"string"==typeof n[2]&&(a+=n[2]),i.push(a),c.push(i)}var s;for(s=0;s<c.length;s+=1)c[s][0]=e(c[s][0],u),c[s][1]=e(c[s][1],d),c[s][2]=e(c[s][2],f);var s,m="\n"+[e("STACK",u),e("INPUT",d),e("ACTION",f)].join("    ")+"\n";for(s=0;s<c.length;s+=1)m+=[c[s][0],c[s][1],c[s][2]].join("    ")+"\n";return m},w.getCurMovementF=function(){var e,t=l[0].join(" "),n="";for(e=0;e<l[1].length;e++)n+=l[1][e].lexeme+" ";n.length>20&&(n=n.substring(0,17)+" ...");var i="";if(l[2].hasOwnProperty("interminal")){if(i=l[2].interminal+" -> ",l[2].hasOwnProperty("product")){0==l[2].product.length&&(i+="ε");for(var e=0;e<l[2].product.length;e++)i+=l[2].product[e]+" "}}else"string"==typeof l[2]&&(i+=l[2]);return[t,n,i].join("  |  ")},w}},Paxer={"new":function(){var e,t,n,i={},r=Parser["new"](),o=Lexer["new"](),a=["NORMAL","WARNING","ERROR","DONE"];return i.reset=function(){t="",n="",e=a[3],o.reset(),r.reset()},i.setInput=function(t){function n(e){for(var t,n="",i=!1,r=0,o=0;o<e.length;o++)t=e[o],"/"==t?r+=1:r=0,"\n"==t&&(i=!1),2==r&&(i=!0),i||(n+=t);return n}i.reset(),o.setInput(n(t)),r.setInput([]),e=a[0]},i.go=function(){if(e==a[0]||e==a[1]){e=a[0];var i=!0;if(r.needPush())switch(o.getStatus()){case"DONE":return;case"ERROR":return t=o.getErrMsg(),void(e=a[2]);case"NORMAL":o.lex(i),r.pushToken(o.getToken());break;default:return console.log("UNEXPECTED LEXER STATUS"),void(e=a[2])}switch(r.parse(i),r.getStatus()){case"DONE":break;case"ERROR":return t=r.getErrMsg(),void(e=a[2]);case"WARNING":n=r.getWarningMsg(),e=a[1];case"NORMAL":break;default:console.log("UNEXPECTED PARSER STATUS"),e=a[2]}o.lexDone()!=r.parseDone()&&(e=a[2]),o.lexDone()&&r.parseDone()&&(e=a[3])}},i.getStatus=function(){return e},i.getErrMsg=function(){return t},i.getWarningMsg=r.getWarningMsg,i.getSymbolTable=o.getSymbolTable,i.getSequentialNodes=r.getSequentialNodes,i.getMovementsF=r.getMovementsF,i.getCurMovementF=r.getCurMovementF,i.getRootS=r.getRootS,i.getTreeChanged=r.getTreeChanged,i}};SemanticError.prototype.toString=function(){var e="Error: "+this.msg;return this.position&&(e=[e," at line: ",this.position.first_row,", ch: ",this.position.first_col].join("")),e},$(function(){function e(e){var t,n=/(\+|\-|\*|\/|!=|>=?|<=?|==?)/g,i=/(\(|\)|\{|}|;|,|\$)/g;return e=e.replace(/\n/g," ").replace(n," $1 ").replace(i," $1 ").replace(/[ ]+/g," ").replace(/(else|then)\s+\{/g,"$1{").replace(/}\s+(else)/,"}$1").trim()+" ",t=e.replace(/(then|else|then\{|else\{|}else\{|\{|}|;)\s/g,"$1\n").replace(/\s+(,|;|\))/g,"$1").replace(/\(\s+/g,"(").replace(/(then|else)\{/g,"$1 {").replace(/}(else)/,"} $1").replace(/([^\n]+)(?=else)/g,"$1\n")}var t=Paxer["new"](),n=new SemanticAnalyzer;ko.applyBindings(mainView=new MainViewModel),window.onbeforeunload=function(){return mainView.editor.unsaved()?"未保存的修改将丢失":void 0},window.onunload=function(){mainView.editor.save(),mainView.fileManager.save()},document.getElementById("btn-tidy").onclick=function(){var t=mainView.editor.getEditorContent();mainView.editor.setEditorContent(e(t));for(var n=0;n<mainView.editor.cm.doc.lastLine();n++)mainView.editor.cm.indentLine(n,"smart");mainView.editor.cm.focus()},document.getElementById("btn-compile").onclick=function(){var n=View.editor.currentSession();if(null!==n){Cache.st={},P("symboltablechanged",[]);var i;View.control.compilie(n.file),n.file.isNewFile?(mainView.console.log("Compile 'untitled'..."),i=View.editor.getContent()):(View.editor.save(),mainView.console.log("Compile '"+n.file.fileName()+"'..."),i=View.editor.currentSession().content),t.setInput(e(i))}};var i=null,r=0,o=0;$.each($(".resizer"),function(e,t){$(t).on("mousedown",function(e){i=t,r=$(i).offset().top-e.clientY,o=$(i).offset().left-e.clientX,$("#resizing-mask").css("cursor",$(i).css("cursor")).show()})}),$(document).on("mouseup",function(){var e=$(i).parent(".resizable");(e.hasClass("bottom-box")||e.hasClass("tree-box"))&&P("treeboxresized"),i=null,$("#resizing-mask").hide()}),document.getElementById("resizing-mask").addEventListener("mousemove",function(e){if(i instanceof HTMLElement){var t=$(i).parent(".resizable");if(t[0]instanceof HTMLElement){var n=$("#main"),a=($(".left-box"),$(".right-box")),s=$(".center-box"),l=$(".upper-box"),c=($(".bottom-box"),$(".editor-box")),u=$(".tree-box");if(t.hasClass("left-box")){var d=e.clientX,f=Math.mid(d+o+5,1,n.width()-a.width()-1);t.width(f-1),s.css("margin-left",f+"px")}if(t.hasClass("right-box")){var d=e.clientX,p=Math.mid(n.width()-(d+o+5),1,n.width()-u.width()-1);t.width(p-1),s.css("margin-right",p+"px")}if(t.hasClass("bottom-box")){var m=e.clientY,h=Math.mid(m+r+5-$(".navbar").height(),0,n.height()-t.children(".box-header").height()-1);t.height(n.height()-h),l.height(h)}if(t.hasClass("tree-box")){var d=e.clientX,p=Math.mid(s.width()-(d+o+5),1,s.width()-1);t.width(p-1),c.css("margin-right",p+"px")}}}},!1),$(document).on("contextmenu",function(){return!1}),context.init({fadeSpeed:0,above:"auto",preventDoubleContext:!0}),context.attach("#file-list",[{text:"New File...",action:function(e){View.editor.newFile()}},{divider:!0},{text:"Rename",action:function(e){var t=$("#file-list").children("li.active"),n=t.attr("id"),i=n.replace(/^toy\-/,"")+".toy";View.editor.dialogRenameFile(Cache.files.find(i))}},{text:"Delete",action:function(e){var t=$("#file-list li.active"),n=t.attr("id").replace(/^toy\-/,""),i=n+".toy",r=Cache.files.find(i);if(confirm("Are you sure to delete '"+r.fileName()+"'?")){r&&Cache.files.remove(r),t.remove();var o=View.editor.openedSessions.findFile(i);o&&View.editor.closeSession(o),Storage.removeItem(i)}}}]),$(document).on("click",function(e){$(".box-open-menu").hide()}),$("#box-opener").on("click",function(e){e.preventDefault(),e.stopPropagation(),$(".box-open-menu").show()}),$.each($(".box-open-menu").find("a"),function(e,t){$(t).on("click",function(e,t){e.preventDefault(),e.stopPropagation(),$(".box-open-menu").hide();var n=$(this).attr("id");if("box-opener-console"==n){var i=$(".bottom-box");i.hasClass("hidden")&&(i.removeClass("hidden").css("height","30%"),$(".upper-box").css("height","70%"),t||P("treeboxresized"))}if("box-opener-workspace"==n){var i=$(".left-box");i.hasClass("hidden")&&(i.removeClass("hidden").css("width","200px"),$(".center-box").css("margin-left","200px"))}if("box-opener-structure"==n){var i=$(".right-box");i.hasClass("hidden")&&(i.removeClass("hidden").css("width","350px"),$(".center-box").css("margin-right","350px"))}if("box-opener-tree"==n){var i=$(".tree-box");i.hasClass("hidden")&&(i.removeClass("hidden").css("width","550px"),$(".editor-box").css("margin-right","550px"))}})}),$.each($(".box-caret"),function(e,t){$(t).on("click",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parents(".resizable");t.hasClass("bottom-box")&&(t.hasClass("hidden")||(t.addClass("hidden"),$(".upper-box").css("height","100%"),P("treeboxresized"))),t.hasClass("left-box")&&(t.hasClass("hidden")||(t.addClass("hidden"),$(".center-box").css("margin-left","0"))),t.hasClass("right-box")&&(t.hasClass("hidden")||(t.addClass("hidden"),$(".center-box").css("margin-right","0"))),t.hasClass("tree-box")&&(t.hasClass("hidden")||(t.addClass("hidden"),t.children(".box-body").css("padding-left","0"),$(".editor-box").css("margin-right","0")))})}),$.each($(".box-expand"),function(e,t){$(t).on("click",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parents(".resizable");t.hasClass("bottom-box")&&(t.hasClass("hidden")||($(".upper-box").css("height","0"),t.css("height","100%")))})}),$("#btn-stop").on("click",function(){View.control.exitCompileMode()}),S("symboltablechanged",function(e){var t,n=$(".right-box .box-body"),i=$(".right-box .placeholder"),r={},o={};if($("#symbol-list").length<1?t=$("<ul></ul>").attr("id","symbol-list").addClass("list").appendTo(n):(t=$("#symbol-list"),$.each(t.children("li"),function(e,t){var n=$(t),i=n.attr("data-id"),a=n.children(".li-caret").hasClass("glyphicon-triangle-bottom"),s=n.hasClass("active");r[i]=a,o[i]=s}),t.empty()),e.length<1)t.hide(),i.show();else{for(var a=0;a<e.length;a++){var s=e[a],l="symbol-"+s.name,c=$("<li></li>").attr("data-id",l).html(s.name),u=$("<span></span>").addClass("glyphicon li-caret").addClass(r[l]?"glyphicon-triangle-bottom":"glyphicon-triangle-right").prependTo(c),d="type: "+s.type+", occurance: "+s.positions.length;$("<span></span>").addClass("extra").text(d).appendTo(c);u.on("click",function(){var e=$(this),t=e.parent(),n=e.hasClass("glyphicon-triangle-right");$.each($("[data-pos='"+t.attr("data-id")+"']"),function(e,t){n?$(t).show():$(t).hide()}),e.toggleClass("glyphicon-triangle-right glyphicon-triangle-bottom")}),c.on("click",function(){var e=$(this);e.hasClass("active")||(e.siblings(".active").removeClass("active"),e.addClass("active"))}).on("dblclick",function(){$(this).trigger("click"),$(this).children(".li-caret").trigger("click")}).on("click",function(e){return function(){return}}(s)).appendTo(t),o[l]&&c.trigger("click");for(var f=0;f<s.positions.length;f++){var p=s.positions[f],m="["+(f+1)+"] line: "+p.first_row+", ch: "+p.first_col,h=$("<li></li>").attr("data-id","pos-"+s.name+"-"+f).attr("data-pos",l).text(m).css("margin-left","30px");r[l]||h.hide(),h.on("click",function(){var e=$(this);e.hasClass("active")||(e.siblings(".active").removeClass("active"),e.addClass("active"))}).on("click",function(e){return function(){}}(p)).appendTo(t),o[h.attr("data-id")]&&h.trigger("click")}}t.show(),i.hide()}});var a=function(e){if(!Cache.st)return Cache.st={},!1;for(var t=0,n=e.length;n>t;t++)if(Cache.st[e[t].name]!=e[t].positions.length)return!1;return!0};$("#btn-next").on("click",function(){if("DONE"!=t.getStatus()&&"ERROR"!=t.getStatus()){switch(t.go(),t.getStatus()){case"DONE":return n.eat(t.getRootS(),t.getSymbolTable()),mainView.console.success(t.getCurMovementF()),mainView.console.success("code parsed."),mainView.console.warn(t.getWarningMsg()),mainView.console.error(n.getErrorMsg()),$(".tree-box").addClass("assembly"),void View.assembly.cm.setValue(n.getAssembly());case"ERROR":return void mainView.console.error(t.getErrMsg());case"WARNING":case"NORMAL":mainView.console.success(t.getCurMovementF()),View.treePen.setSource(t.getSequentialNodes()),View.treePen.render()}var e=t.getSymbolTable();if(!a(e)){for(var i=0,r=e.length;r>i;i++)Cache.st[e[i].name]=e[i].positions.length;P("symboltablechanged",e)}}}),S("semantichaserror",function(e){for(var t=0;t<e.length;t++)mainView.console.error(e[t].toString())}),$("#btn-ff").on("click",function(){if("DONE"==t.getStatus())mainView.console.success("code parsed.");else if("ERROR"==t.getStatus())mainView.console.error(t.getErrMsg());else{for(Benchmark.mark("parse");"DONE"!=t.getStatus()&&"ERROR"!=t.getStatus();)t.go();switch(t.getStatus()){case"DONE":n.eat(t.getRootS(),t.getSymbolTable());var e=Benchmark.measure("parse");$(".tree-box").addClass("assembly"),View.assembly.cm.setValue(n.getAssembly()),mainView.console.success(t.getMovementsF()),mainView.console.warn(t.getWarningMsg()),mainView.console.error(n.getErrorMsg()),mainView.console.success("Compile finished in "+e.toFixed(4)+" millisecs."),mainView.console.success("Can we make it faster?");break;case"ERROR":mainView.console.error(t.getErrMsg())}}}),mainView.console.log("Compiler lauched at "+(new Date).toTimeString()),$(".loading-mask").remove()});