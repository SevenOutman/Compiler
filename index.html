<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Compiler</title>
    <!-- Bootstrap -->
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="lib/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="lib/monokai-so.css">
    <link rel="stylesheet" href="lib/codemirror/theme/base16-dark.css">
    <link rel="stylesheet" href="lib/codemirror/theme/dracula.css">
    <link rel="stylesheet" href="lib/codemirror/addon/dialog/dialog.css">
    <link rel="stylesheet" href="lib/codemirror/addon/scroll/simplescrollbars.css">
    <link rel="stylesheet" href="css/style.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="wrapper">
    <div id="resizing-mask"></div>
    <nav class="navbar navbar-inverse navbar-fixed-top" style="margin-bottom: 0">
        <div class="container-fluid" style="padding-right: 15px">
            <div class="navbar-header">
                <a href class="navbar-brand">
                    <span class="glyphicon glyphicon-console"></span> Compiler
                </a>
            </div>
            <ul class="nav navbar-nav navbar-left">
                <li>
                    <button class="btn navbar-btn-o">
                        <span class="glyphicon glyphicon-cog"></span>
                    </button>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <button class="btn navbar-btn-o" id="btn-save"><span
                            class="glyphicon glyphicon-floppy-disk"></span> Save
                    </button>
                </li>
                <li>
                    <button class="btn navbar-btn" id="btn-tidy"><span
                            class="glyphicon glyphicon-flash"></span> Tidy
                    </button>
                </li>
                <li>
                    <label class="btn navbar-btn" id="btn-import" for="source_file"><span
                            class="glyphicon glyphicon-import"></span> Import</label>
                </li>
                <li>
                    <button class="btn navbar-btn" id="btn-compile"><span
                            class="glyphicon glyphicon-download-alt"></span> Compile
                    </button>
                </li>
            </ul>
        </div>
    </nav>

    <div id="main">
        <div class="left-box resizable">
            <div class="resizer vertical"></div>
            <div class="box-header">
                <div class="box-title">Workspace</div>
            </div>
            <div class="box-body">
                <div class="placeholder">Nothing to show</div>
            </div>
        </div>

        <div class="right-box resizable">
            <div class="resizer vertical"></div>
            <div class="box-header">
                <div class="box-title">Symbol Table</div>
            </div>
            <div class="box-body">
                <div class="placeholder">Nothing to show</div>
            </div>
        </div>
        <div class="center-box">
            <div class="editor-box">
                <div class="editor-placeholder">
                    Choose a file from workspace or <a id="cover-open">open a new file</a>
                </div>
                <div class="tab-bar">
                    <button class="tab-new">&plus;</button>
                    <div class="tab-row">
                        <div class="tab-group">
                        </div>
                    </div>
                </div>
                <div class="editor-container">
                    <textarea id="editor"></textarea>
                </div>
            </div>
            <div class="bottom-box resizable">
                <div class="resizer horizontal"></div>
                <div class="box-header">
                    <div class="box-title">Console</div>
                </div>
                <div class="console-container">
                    <textarea id="console"></textarea>
                </div>
            </div>
        </div>
    </div>
    <div id="footer">
        <div class="footer-text" id="cursor-position" style="display: none">
            <span id="current-line">1</span>:<span id="current-ch">1</span>
        </div>
    </div>
    <div id="extra">
        <div id="other_div"></div>
        <input type="file" name="" id="source_file" style="display: none;">
    </div>
</div>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!--<script src="js/jquery-2.1.4.min.js"></script>-->
<script src="lib/datavjs/deps/jquery-1.7.1.js"></script>
<!--<script src="lib/jquery-2.1.4.min.js"></script>-->

<!-- Include all compiled plugins (below), or include individual files as needed -->
<!--<script src="lib/bootstrap/js/bootstrap.min.js"></script>-->
<script type="text/javascript" src="lib/datavjs/deps/d3.min.js"></script>
<script type="text/javascript" src="lib/datavjs/deps/d3.csv.js"></script>
<script type="text/javascript" src="lib/datavjs/deps/d3.layout.min.js"></script>
<script type="text/javascript" src="lib/datavjs/deps/raphael.min.js"></script>
<script src="lib/datavjs/deps/eventproxy.js"></script>
<script src="lib/datavjs/datav.js"></script>
<script src="lib/datavjs/libs/tree.js"></script>
<script src="js/include.js"></script>
<script src="js/Symbol.js"></script>
<script src="js/Lexical.js"></script>
<script src="js/LL.js"></script>
<script src="lib/codemirror/lib/codemirror.js"></script>
<script src="lib/codemirror/addon/dialog/dialog.js"></script>
<script src="lib/codemirror/addon/edit/matchbrackets.js"></script>
<script src="lib/codemirror/addon/edit/closebrackets.js"></script>
<script src="lib/codemirror/addon/selection/active-line.js"></script>
<script src="lib/codemirror/addon/scroll/simplescrollbars.js"></script>
<script src="lib/codemirror/addon/selection/selection-pointer.js"></script>
<script src="lib/codemirror/mode/diff/diff.js"></script>
<script src="lib/codemirror/mode/javascript/javascript.js"></script>
<script src="lib/toy.js"></script>
<script src="lib/console.js"></script>
<script src="js/Storage.js"></script>
<script src="js/Cache.js"></script>
<script src="js/ToyFile.js"></script>
<script src="js/View.js"></script>
<script src="js/Paxer.js"></script>
<script src="js/script.js"></script>
<script>

    CodeMirror.commands.save = function(cm) {
        View.editor.save();
    };

    window.onbeforeunload = function() {
        if (View.editor.needSave()) {
            return "未保存的修改将丢失";
        }
    };

    window.onunload = function() {
        var session = View.editor.currentSession();
        if (session && session.file) {

            Storage.setItem("last-editing", session.file.fileName());
        } else {
            Storage.removeItem("last-editing");
        }
        var storedFiles = [];
        for (var i = 0; i < Cache.files.length; i++) {
            storedFiles.push(Cache.files[i].fileName());
        }
        Storage.setItem("stored-files", JSON.stringify(storedFiles));
    };

    window.onload = function() {
        // var lexical = new LexicalAnalyzer;
        // var ll = new LLParser();
        var lexer = Lexer.new();
        var parser = Parser.new();
        document.getElementById("cover-open").addEventListener("click", function() {
            View.editor.newFile();
        }, false);
        Cache.files = [];
        Cache.files.find = function(fileName) {
            for (var i = 0; i < this.length; i++) {
                if (this[i].fileName() === fileName) {
                    return this[i];
                }
            }
            return null;
        }.bind(Cache.files);

        Cache.files.sub("change", function() {
            if ($("#file-list").length < 1 && this.length > 0) {
                var $ul         = $("<ul></ul>").attr("id", "file-list"),
                    placeholder = $(".left-box .placeholder")[0];
                placeholder.parentNode.removeChild(placeholder);
                $ul.appendTo($(".left-box .box-body"));
            }
            for (var i = 0; i < this.length; i++) {
                var file = this[i],
                    id   = "toy-" + file.name;
                if ($("#" + id).length < 1) {
                    var $li = $("<li></li>").attr("id", id).text(file.fileName());
                    $li.on("click", function() {
                        var $self = $(this);
                        if (!$self.hasClass("active")) {
                            $self.siblings(".active").removeClass("active");
                            $self.addClass("active");
                        }
                    }).on("dblclick", (function(file) {
                        return function() {
                            View.editor.openFile(file);
                        }
                    })(file));
                    $("#file-list").append($li);
                }
            }
        });
        Cache.storedFileNames = JSON.parse(Storage.getItem("stored-files") || "[]");
        for (var i = 0; i < Cache.storedFileNames.length; i++) {
            var item = Storage.getItem(Cache.storedFileNames[i]);
            if (item) {
                var file = JSON.parse(item);
                Cache.files.push(new ToyFile(Cache.storedFileNames[i], file.content, false));
            }
        }
        Cache.files.pub("change");


        var last = Storage.getItem("last-editing");
        if (last) {
            var file = Cache.files.find(last);
            if (file) {
                View.editor.openFile(file);
                $("#toy-" + file.name).trigger("click");
            }
        }

        document.getElementById("btn-tidy").onclick = function() {
            var code      = View.editor.getContent().replace(/\n/g, " "),
                processed = "",
                buffer    = "";
            var findOperatorReg  = /(\+|\-|\*|\/|!=|>=?|<=?|==?)/g,
                findDelimiterReg = /(\(|\)|\{|}|;|\$)/g;
            code = code.replace(findOperatorReg, " $1 ")
                           .replace(findDelimiterReg, " $1 ")
                           .replace(/[ ]+/g, " ")
                           .replace(/(else|then) \{/g, "$1{")
                           .trim() + " ";
            for (var i = 0; i < code.length; i++) {
                if (code[i] == " ") {
                    processed += buffer;

                    if (["then", "else", "then{", "else{", "{", "}", ";"].has(buffer)) {
                        processed += "\n";
                    } else {
                        processed += " ";
                    }

                    buffer = "";
                } else {
                    buffer += code[i];
                }
            }
            processed = processed.replace(/\s+(;|\))/g, "$1")
                    .replace(/\(\s+/g, "(")
                    .replace(/(then|else)\{/g, "$1 {");
            View.editor.setContent(processed);
            for (var i = 0; i < View.editor.cm.doc.lastLine(); i++) {
                View.editor.cm.indentLine(i, "smart");
            }
            View.editor.cm.focus();
        };

        document.getElementById("btn-compile").onclick = function() {
            // var processed = lexical.run(View.editor.getContent());
            // ll.run(processed);
            var session = View.editor.currentSession();
            if (null !== session) {

                if ($(".bottom-box").height() <= 30) {
                    View.console.popup();
                }
                if (!session.file.isNewFile) {

                    View.editor.save();
                    View.console.log("Compile '" + session.file.fileName() + "'...");

                } else {
                    View.console.log("Compile 'untitled'...");
                }

                if (lexer.lex(View.editor.getContent())) {

                    if (lexer.lex(View.editor.getContent())) {
                        if (parser.parse(lexer.getSequence())) {
                            View.console.log(parser.getMovementsF());
                        } else {
                            View.console.log(parser.getErrMsg());
                        }
                    } else {
                        View.console.log(lexer.getErrMsg());
                    }
                }
            }
            ;

            $(".tab-new").on("click", function() {
                View.editor.newFile();
            });

            var fr      = new FileReader,
                tmpFile = null;
            fr.onload = function() {
                if (null !== tmpFile) {
                    tmpFile.content = this.result;
                    Cache.files.push(tmpFile);
                    Cache.files.pub("change");
                    View.editor.openFile(tmpFile);
                    $("#toy-" + tmpFile.id).trigger("click");
                    tmpFile = null;
                }
            };
            document.getElementById("source_file").onchange = function() {
                var file = this.files[0];
                tmpFile = new ToyFile(file.name.replace(/(\.\w+)?$/, ".toy"));
                tmpFile.isNewFile = false;
                fr.readAsText(file);
            };
            document.getElementById("btn-save").onclick = function() {
                View.editor.save();
            };
            var moving_resizer = null,
                mouseOffsetY   = 0,
                mouseOffsetX   = 0;
            [].forEach.call($(".resizer"), function(el) {
                el.addEventListener("mousedown", function(e) {
                    moving_resizer = el;
                    mouseOffsetY = $(moving_resizer).offset().top - e.clientY;
                    mouseOffsetX = $(moving_resizer).offset().left - e.clientX;
                    $("#resizing-mask").css("cursor", $(moving_resizer).css("cursor")).show();

                }, false);
            });
            document.addEventListener("mouseup", function() {
                moving_resizer = null;
                $("#resizing-mask").hide();
            }, false);
            document.getElementById("resizing-mask").addEventListener("mousemove", function(e) {
                if (moving_resizer instanceof HTMLElement) {
                    var $box = $(moving_resizer).parent(".resizable");
                    if ($box[0] instanceof HTMLElement) {
                        var $main   = $("#main"),
                            $left   = $(".left-box"),
                            $right  = $(".right-box"),
                            $center = $(".center-box"),
                            $bottom = $(".bottom-box"),
                            $editor = $(".editor-box");
                        if ($box.hasClass("left-box")) {
                            var mouseX    = e.clientX,
                                leftWidth = Math.mid(mouseX + mouseOffsetX + 5,
                                        1, $main.width() - $right.width() - 1);

                            $box.width(leftWidth);
                            $center.css("margin-left", leftWidth + "px");

                        }
                        if ($box.hasClass("right-box")) {
                            var mouseX     = e.clientX,
                                rightWidth = Math.mid($main.width() - (mouseX + mouseOffsetX + 5),
                                        1, $main.width() - $left.width() - 1);
                            $box.width(rightWidth);
                            $center.css("margin-right", rightWidth + "px");
                        }
                        if ($box.hasClass("bottom-box")) {
                            var mouseY      = e.clientY,
                                upperHeight = Math.mid(mouseY + mouseOffsetY + 5 - $(".navbar").height(),
                                        0, $center.height() - $box.children(".box-header").height() - 1);
                            $box.height($center.height() - upperHeight);
                            $editor.height(upperHeight);
                            View.console.scollToEnd();
                        }
                    }
                }
            }, false);
            View.console.log("Compiler lauched at " + new Date().toTimeString());
        }
    }
</script>
</body>

</html>
