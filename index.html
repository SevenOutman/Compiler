<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Compiler</title>
    <!-- Bootstrap -->
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="lib/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="lib/monokai-so.css">
    <link rel="stylesheet" href="lib/codemirror/addon/dialog/dialog.css">
    <link rel="stylesheet" href="lib/codemirror/addon/scroll/simplescrollbars.css">
    <link rel="stylesheet" href="lib/contextjs/context.standalone.css">
    <link rel="stylesheet" href="css/style.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="wrapper">
    <div id="tree-mask"></div>
    <div id="resizing-mask"></div>
    <nav class="navbar navbar-inverse navbar-fixed-top" style="margin-bottom: 0">
        <div class="container-fluid" style="padding-right: 15px">
            <div class="navbar-header">
                <a href class="navbar-brand">
                    <span class="glyphicon glyphicon-console"></span> Compiler
                </a>
            </div>
            <ul class="nav navbar-nav navbar-left">
                <li>
                    <button class="btn navbar-btn-o">
                        <span class="glyphicon glyphicon-cog"></span>
                    </button>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <button class="btn navbar-btn-o" id="btn-save"><span
                            class="glyphicon glyphicon-floppy-disk"></span> Save
                    </button>
                </li>
                <li>
                    <button class="btn navbar-btn" id="btn-tidy"><span
                            class="glyphicon glyphicon-flash"></span> Tidy
                    </button>
                </li>
                <li>
                    <label class="btn navbar-btn" id="btn-import" for="source_file"><span
                            class="glyphicon glyphicon-import"></span> Import</label>
                </li>
                <li>
                    <button class="btn navbar-btn" id="btn-compile"><span
                            class="glyphicon glyphicon-download-alt"></span> Compile
                    </button>
                </li>
            </ul>
        </div>
    </nav>

    <div id="main">
        <div class="left-box resizable">
            <div class="resizer vertical"></div>
            <div class="box-header">
                <div class="box-title">Workspace</div>
                <span class="box-caret glyphicon glyphicon-menu-left"></span>
            </div>
            <div class="box-body">
                <div class="placeholder">Nothing to show</div>
            </div>
        </div>

        <div class="right-box resizable hidden">
            <div class="resizer vertical"></div>
            <div class="box-header">
                <div class="box-title">Structure</div>
                <span class="box-caret glyphicon glyphicon-menu-right"></span>
            </div>
            <div class="box-body">
                <div class="placeholder">Nothing to show</div>
            </div>
        </div>
        <div class="center-box">
            <div class="editor-box">
                <div class="editor-placeholder">
                    Choose a file from workspace or <a id="cover-open">create a new file</a>
                </div>
                <div class="tab-bar">
                    <button class="tab-new">&plus;</button>
                    <div class="tab-row">
                        <div class="tab-group">
                        </div>
                    </div>
                </div>
                <div class="editor-container">
                    <textarea id="editor"></textarea>
                </div>
            </div>
            <div class="bottom-box resizable hidden">
                <div class="resizer horizontal"></div>
                <div class="box-header">
                    <div class="box-title">Console</div>
                    <span class="box-caret glyphicon glyphicon-menu-down"></span>
                </div>
                <div class="console-container">
                    <textarea id="console"></textarea>
                </div>
            </div>
        </div>
    </div>
    <div id="footer">
        <div class="footer-text">
            <span class="glyphicon glyphicon-collapse-up" id="box-opener"></span>
            <ul class="dropdown-menu box-open-menu">
                <li>
                    <a id="box-opener-workspace">Workspace</a>
                </li>
                <li>
                    <a id="box-opener-structure">Structure</a>
                </li>
                <li>
                    <a id="box-opener-console">Console</a>
                </li>
            </ul>
        </div>
        <div class="footer-text" id="cursor-position" style="display: none">
            <span id="current-line">1</span>:<span id="current-ch">1</span>
        </div>
    </div>
    <div id="extra">
        <div id="other_div"></div>
        <input type="file" name="" id="source_file" style="display: none;">
    </div>
</div>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="lib/jquery-2.1.4.min.js"></script>
<script>
    $.browser = {};
    $.browser.msie = !$.support.leadingWhitespace;
</script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<!--<script src="lib/bootstrap/js/bootstrap.min.js"></script>-->
<script src="lib/contextjs/context.js"></script>
<script src="lib/datavjs/deps/d3.min.js"></script>
<script src="lib/datavjs/deps/d3.csv.js"></script>
<script src="lib/datavjs/deps/d3.layout.min.js"></script>
<script src="lib/datavjs/deps/raphael.min.js"></script>
<script src="lib/datavjs/deps/eventproxy.js"></script>
<script src="lib/datavjs/datav.js"></script>
<script src="lib/datavjs/libs/tree.js"></script>
<!--<script src="js/Symbol.js"></script>-->
<!--<script src="js/Lexical.js"></script>-->
<!--<script src="js/LL.js"></script>-->
<script src="lib/codemirror/lib/codemirror.js"></script>
<script src="lib/codemirror/addon/dialog/dialog.js"></script>
<script src="lib/codemirror/addon/edit/matchbrackets.js"></script>
<script src="lib/codemirror/addon/edit/closebrackets.js"></script>
<script src="lib/codemirror/addon/selection/active-line.js"></script>
<script src="lib/codemirror/addon/scroll/simplescrollbars.js"></script>
<script src="lib/codemirror/addon/selection/selection-pointer.js"></script>

<script src="js/include.js"></script>
<script src="lib/toy.js"></script>
<script src="lib/console.js"></script>
<script src="js/PubSub.js"></script>
<script src="js/Storage.js"></script>
<script src="js/Cache.js"></script>
<script src="js/ToyFile.js"></script>
<script src="js/View.js"></script>
<script src="js/Paxer.js"></script>
<script src="js/script.js"></script>
<script>

    CodeMirror.commands.save = function() {
        View.editor.save();
    };

    window.onbeforeunload = function() {
        if (View.editor.needSave()) {
            return "未保存的修改将丢失";
        }
    };

    window.onunload = function() {
        var session = View.editor.currentSession();
        if (session && session.file) {

            Storage.setItem("last-editing", session.file.fileName());
        } else {
            Storage.removeItem("last-editing");
        }
        var storedFiles = [];
        for (var i = 0; i < Cache.files.length; i++) {
            storedFiles.push(Cache.files[i].fileName());
        }
        Storage.setItem("stored-files", JSON.stringify(storedFiles));
    };

    window.onload = function() {
        // var lexical = new LexicalAnalyzer;
        // var ll = new LLParser();
        var lexer = Lexer.new();
        var parser = Parser.new();

        Sub(document).to("codeinput", function() {
            lexer.lex(View.editor.getContent());
            Pub("symboltablechange").on(document);
        }).to("symboltablechange", function() {
            return;
            var st = lexer.getSymbolTable();
            if ($("#symbol-list").length < 1 && st.length > 0) {
                var $ul = $("<ul></ul>").attr("id", "symbol-list").addClass("list");
                $(".right-box .placeholder").remove();
                $ul.appendTo($(".right-box .box-body"));
            }
            $("#symbol-list").empty();
            for (var i = 0; i < st.length; i++) {
                var symbol = st[i],
                    id     = "sym-" + symbol.name;
                if ($("[data-id='" + id + "']").length < 1) {
                    var $li    = $("<li></li>").attr("data-id", id).text(symbol.name),
                        $extra = $("<span></span>").addClass("extra").text(symbol.type);
                    $li.on("click", function() {
                        var $self = $(this);
                        if (!$self.hasClass("active")) {
                            $self.siblings(".active").removeClass("active");
                            $self.addClass("active");
                        }
                    });
                    $("#symbol-list").append($li.append($extra));
                }
            }
        });

        document.getElementById("cover-open").addEventListener("click", function() {
            View.editor.newFile();
        }, false);
        Cache.files = [];
        Cache.files.find = function(fileName) {
            for (var i = 0; i < this.length; i++) {
                if (this[i].fileName() === fileName) {
                    return this[i];
                }
            }
            return null;
        }.bind(Cache.files);

        Sub(Cache.files).to("change", function() {
            if ($("#file-list").length < 1 && this.length > 0) {
                var $ul = $("<ul></ul>").attr("id", "file-list").addClass("list");
                $(".left-box .placeholder").remove();
                $ul.appendTo($(".left-box .box-body"));
            }
            for (var i = 0; i < this.length; i++) {
                var file = this[i],
                    id   = "toy-" + file.name;
                if ($("#" + id).length < 1) {
                    var $li   = $("<li></li>").attr("id", id).text(file.fileName()),
                        $icon = $("<span></span>").addClass("glyphicon glyphicon-file");
                    $li.on("click", function() {
                        var $self = $(this);
                        if (!$self.hasClass("active")) {
                            $self.siblings(".active").removeClass("active");
                            $self.addClass("active");
                        }
                    }).on("contextmenu", function() {
                        $(this).trigger("click");
                    }).on("dblclick", (function(file) {
                        return function() {
                            View.editor.openFile(file);
                        }
                    })(file));
                    $("#file-list").append($li.prepend($icon));
                }
            }
        });
        Cache.storedFileNames = JSON.parse(Storage.getItem("stored-files") || "[]");
        for (var i = 0; i < Cache.storedFileNames.length; i++) {
            var item = Storage.getItem(Cache.storedFileNames[i]);
            if (item) {
                var file = JSON.parse(item);
                Cache.files.push(new ToyFile(Cache.storedFileNames[i], file.content, false));
            }
        }
        Pub("change").on(Cache.files);


        var last = Storage.getItem("last-editing");
        if (last) {
            var file = Cache.files.find(last);
            if (file) {
                View.editor.openFile(file);
                $("#toy-" + file.name).trigger("click");
            }
        }

        document.getElementById("btn-tidy").onclick = function() {
            var code      = View.editor.getContent().replace(/\n/g, " "),
                processed = "",
                buffer    = "";
            var findOperatorReg  = /(\+|\-|\*|\/|!=|>=?|<=?|==?)/g,
                findDelimiterReg = /(\(|\)|\{|}|;|\$)/g;
            code = code.replace(findOperatorReg, " $1 ")
                           .replace(findDelimiterReg, " $1 ")
                           .replace(/[ ]+/g, " ")
                           .replace(/(else|then)\s+\{/g, "$1{")
                           .replace(/}\s+(else)/, "}$1")
                           .trim() + " ";
            for (var i = 0; i < code.length; i++) {
                if (code[i] == " ") {
                    processed += buffer;

                    if (["then", "else", "then{", "else{", "}else{", "{", "}", ";"].has(buffer)) {
                        processed += "\n";
                    } else {
                        processed += " ";
                    }

                    buffer = "";
                } else {
                    buffer += code[i];
                }
            }
            processed = processed.replace(/\s+(;|\))/g, "$1")
                    .replace(/\(\s+/g, "(")
                    .replace(/(then|else)\{/g, "$1 {")
                    .replace(/}(else)/, "} $1");
            View.editor.setContent(processed);
            for (var i = 0; i < View.editor.cm.doc.lastLine(); i++) {
                View.editor.cm.indentLine(i, "smart");
            }
            View.editor.cm.focus();
        };

        document.getElementById("btn-compile").onclick = function() {

            var session = View.editor.currentSession();
            if (null !== session) {

                View.console.popup();
                if (!session.file.isNewFile) {

                    View.editor.save();
                    View.console.log("Compile '" + session.file.fileName() + "'...");

                } else {
                    View.console.log("Compile 'untitled'...");
                }
                // var processed = (new LexicalAnalyzer).run(View.editor.getContent());
                // (new LLParser).run(processed);
                if (lexer.lex(View.editor.getContent())) {
                    if (parser.parse(lexer.getSequence())) {
                        View.console.success(parser.getMovementsF());
                        var output = "",
                            level  = 0,
                            root   = parser.getRoot();
                        if ($("#symbol-list").length < 1 && root) {
                            var $ul = $("<ul></ul>").attr("id", "symbol-list").addClass("list");
                            $(".right-box .placeholder").remove();
                            $ul.appendTo($(".right-box .box-body"));
                        }
                        $("#symbol-list").empty();
                        scanTree(root, "none");

//                        View.console.log(output);
                        function scanTree(node, parentMark) {
                            var indent = "",
                                n      = 1;
                            while ($("[data-id='structure-" + node.abstract + "-" + n + "']").length > 0) {
                                n++;
                            }
                            for (var i = 0; i < level; i++) {
                                output += "  ";
                                indent += "&nbsp;&nbsp;";
                            }
                            output += node.abstract + "\n";

                            var id     = "structure-" + node.abstract + "-" + n,
                                $li    = $("<li></li>").attr("data-id", id).attr("data-parent", parentMark).html(node.abstract),
                                $caret = $("<span></span>").addClass("glyphicon glyphicon-triangle-bottom li-caret")
                                        .css("margin-left", (level * 15 - 15) + "px")
                                        .on("click", function(e) {
                                            toggleFode($li, $caret.hasClass("glyphicon-triangle-bottom"));
                                        });
                            if (node.getSubNodes().length < 1) {
                                $caret.addClass("no-child");
                            }
                            $li.on("click", function() {
                                var $self = $(this);
                                if (!$self.hasClass("active")) {
                                    $self.siblings(".active").removeClass("active");
                                    $self.addClass("active");
                                }
                            });
                            $("#symbol-list").append($li.prepend($caret));
                            for (var i = 0, subs = node.getSubNodes(); i < subs.length; i++) {
                                level++;
                                scanTree(subs[i], id);
                            }
                            level--;
                        }

                        function toggleFode($li, fold, includeSelf) {
                            var id = $li.attr("data-id");

                            $.each($("[data-parent='" + id + "']"), function(index, el) {
//                                    $(el).toggle();
                                toggleFode($(el), fold, true);
                            });
                            if (includeSelf) {
                                if (fold) {
                                    $li.hide();
                                } else {
                                    $li.show();
                                }
                            }
                            if (fold) {
                                $li.find(".li-caret").removeClass("glyphicon-triangle-bottom")
                                        .addClass("glyphicon-triangle-right");
                            } else {
                                $li.find(".li-caret").addClass("glyphicon-triangle-bottom")
                                        .removeClass("glyphicon-triangle-right");
                            }

                        }
                    } else {
                        View.console.error(parser.getErrMsg());
                    }
                } else {
                    View.console.error(lexer.getErrMsg());
                }
            }
        };

        $(".tab-new").on("click", function() {
            View.editor.newFile();
        });

        var fr      = new FileReader,
            tmpFile = null;
        fr.onload = function() {
            if (null !== tmpFile) {
                tmpFile.content = this.result;
                Cache.files.push(tmpFile);
                Pub("change").on(Cache.files);
                View.editor.openFile(tmpFile);
                $("#toy-" + tmpFile.id).trigger("click");
                tmpFile = null;
            }
        };
        document.getElementById("source_file").onchange = function() {
            var file = this.files[0];
            tmpFile = new ToyFile(file.name.replace(/(\.\w+)?$/, ".toy"));
            tmpFile.isNewFile = false;
            fr.readAsText(file);
        };
        document.getElementById("btn-save").onclick = function() {
            View.editor.save();
        };
        var moving_resizer = null,
            mouseOffsetY   = 0,
            mouseOffsetX   = 0;
        [].forEach.call($(".resizer"), function(el) {
            el.addEventListener("mousedown", function(e) {
                moving_resizer = el;
                mouseOffsetY = $(moving_resizer).offset().top - e.clientY;
                mouseOffsetX = $(moving_resizer).offset().left - e.clientX;
                $("#resizing-mask").css("cursor", $(moving_resizer).css("cursor")).show();

            }, false);
        });
        document.addEventListener("mouseup", function() {
            moving_resizer = null;
            $("#resizing-mask").hide();
        }, false);
        document.getElementById("resizing-mask").addEventListener("mousemove", function(e) {
            if (moving_resizer instanceof HTMLElement) {
                var $box = $(moving_resizer).parent(".resizable");
                if ($box[0] instanceof HTMLElement) {
                    var $main   = $("#main"),
                        $left   = $(".left-box"),
                        $right  = $(".right-box"),
                        $center = $(".center-box"),
                        $bottom = $(".bottom-box"),
                        $editor = $(".editor-box");
                    if ($box.hasClass("left-box")) {
                        var mouseX    = e.clientX,
                            leftWidth = Math.mid(mouseX + mouseOffsetX + 5,
                                    1, $main.width() - $right.width() - 1);

                        $box.width(leftWidth - 1);
                        $center.css("margin-left", leftWidth + "px");

                    }
                    if ($box.hasClass("right-box")) {
                        var mouseX     = e.clientX,
                            rightWidth = Math.mid($main.width() - (mouseX + mouseOffsetX + 5),
                                    1, $main.width() - $left.width() - 1);
                        $box.width(rightWidth - 1);
                        $center.css("margin-right", rightWidth + "px");
                    }
                    if ($box.hasClass("bottom-box")) {
                        var mouseY      = e.clientY,
                            upperHeight = Math.mid(mouseY + mouseOffsetY + 5 - $(".navbar").height(),
                                    0, $center.height() - $box.children(".box-header").height() - 1);
                        $box.height($center.height() - upperHeight);
                        $editor.height(upperHeight);
                        View.console.scollToEnd();
                    }
                }
            }
        }, false);
        $(document).on("contextmenu", function() {
            return false;
        });
        context.init({
            fadeSpeed:            0,
            above:                "auto",
            preventDoubleContext: true
        });
        context.attach("#file-list", [
            {
                text:   "New File...",
                action: function(e) {
                    View.editor.newFile()
                }
            },
            {
                divider: true
            },
            {
                text: "Rename"
            },
            {
                text:   "Delete",
                action: function(e) {
                    var $li      = $("#file-list li.active"),
                        name     = $li.attr("id").replace(/^toy\-/, ""),
                        fileName = name + ".toy",
                        file     = Cache.files.find(fileName);
                    if (confirm("Are you sure to delete '" + file.fileName() + "'?")) {
                        if (file) {
                            Cache.files.remove(file);
                        }
                        $li.remove();
                        var session = View.editor.openedSessions.findFile(fileName);
                        if (session) {
                            View.editor.closeSession(session);
                        }
                        Storage.removeItem(fileName);
                    }
                }
            }
        ]);
        $(document).on("click", function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(".box-open-menu").hide();
        });
        $("#box-opener").on("click", function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(".box-open-menu").show();
        });
        $.each($(".box-open-menu").find("a"), function(index, el) {
            $(el).on("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(".box-open-menu").hide();
                var id = $(this).attr("id");
                if (id == "box-opener-console") {
                    var $box = $(".bottom-box");
                    if ($box.hasClass("hidden")) {
                        $box.removeClass("hidden").css("height", "30%");
                        $(".editor-box").css("height", "70%");
                    }
                }
                if (id == "box-opener-workspace") {
                    var $box = $(".left-box");
                    if ($box.hasClass("hidden")) {
                        $box.removeClass("hidden").css("width", "200px");
                        $(".center-box").css("margin-left", "200px");
                    }
                }
                if (id == "box-opener-structure") {
                    var $box = $(".right-box");
                    if ($box.hasClass("hidden")) {
                        $box.removeClass("hidden").css("width", "200px");
                        $(".center-box").css("margin-right", "200px");
                    }
                }
            });
        });
        $.each($(".box-caret"), function(index, el) {
            $(el).on("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                var $box = $(this).parents(".resizable");
                if ($box.hasClass("bottom-box")) {
                    if (!$box.hasClass("hidden")) {
                        $box.addClass("hidden");
                        $(".editor-box").css("height", "100%");
                    }
                }
                if ($box.hasClass("left-box")) {
                    if (!$box.hasClass("hidden")) {
                        $box.addClass("hidden");
                        $(".center-box").css("margin-left", "0");
                    }
                }
                if ($box.hasClass("right-box")) {
                    if (!$box.hasClass("hidden")) {
                        $box.addClass("hidden");
                        $(".center-box").css("margin-right", "0");
                    }
                }
            });
        });
        View.console.log("Compiler lauched at " + new Date().toTimeString());
    };
</script>
</body>

</html>
